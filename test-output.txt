bun test v1.3.8 (b64edcb4)

src\__tests__\api\projects\groups.test.ts:
(pass) POST /api/projects/[id]/groups - Security Tests > Owner-First Permission Pattern > should allow project owner to create group
(pass) POST /api/projects/[id]/groups - Security Tests > Owner-First Permission Pattern > should allow member with can_edit_project permission
(pass) POST /api/projects/[id]/groups - Security Tests > Owner-First Permission Pattern > should deny member without can_edit_project permission
(pass) POST /api/projects/[id]/groups - Security Tests > Owner-First Permission Pattern > should deny non-member
(pass) POST /api/projects/[id]/groups - Security Tests > Validation > should reject name shorter than 2 characters
(pass) POST /api/projects/[id]/groups - Security Tests > Validation > should accept group without description
Create group error: 198 | 
199 |       // Mock: Insert group succeeds
200 |       mockQuery.mockResolvedValueOnce([{ insertId: 23 }]);
201 | 
202 |       // Mock: Insert permissions fails
203 |       mockQuery.mockRejectedValueOnce(new Error('Permission insert failed'));
                                                ^
error: Permission insert failed
      at <anonymous> (C:\Users\Jhonatan\Documents\git\lazykanban\src\__tests__\api\projects\groups.test.ts:203:43)

(pass) POST /api/projects/[id]/groups - Security Tests > Transaction Handling > should rollback on error during group creation
(pass) POST /api/projects/[id]/groups - Security Tests > Transaction Handling > should create default permissions with all false

src\__tests__\api\projects\tags.test.ts:
(pass) POST /api/projects/[id]/tags - Security Tests > Owner-First Permission Pattern > should allow project owner to create tag (even without group membership)
94 |       const response = await POST(req, mockParams(projectId));
95 | 
96 |       expect(response.status).toBe(201);
97 | 
98 |       // Verify both checks were called
99 |       expect(mockQuery).toHaveBeenNthCalledWith(
                             ^
error: expect(received).toHaveBeenNthCalledWith(n, ...expected)

Call #1:
  [
-   StringContaining "WHERE id = ? AND owner_id = ?",
+   "SELECT id FROM projects WHERE id = ? AND owner_id = ?",
    [
      "10",
-     2,
+     1,
    ],
  ]

- Expected  - 2
+ Received  + 2

      at <anonymous> (C:\Users\Jhonatan\Documents\git\lazykanban\src\__tests__\api\projects\tags.test.ts:99:25)
(fail) POST /api/projects/[id]/tags - Security Tests > Owner-First Permission Pattern > should allow member with can_manage_tags permission
(pass) POST /api/projects/[id]/tags - Security Tests > Owner-First Permission Pattern > should deny member without can_manage_tags permission
(pass) POST /api/projects/[id]/tags - Security Tests > Owner-First Permission Pattern > should deny non-member (user not in project)
(pass) POST /api/projects/[id]/tags - Security Tests > Validation > should reject missing name
(pass) POST /api/projects/[id]/tags - Security Tests > Validation > should reject invalid color format
(pass) POST /api/projects/[id]/tags - Security Tests > Validation > should use default color if not provided
Create tag error: 201 |       const userId = 1;
202 |       const projectId = '10';
203 |       const tagData = { name: 'Bug', color: '#FF0000' };
204 | 
205 |       // Mock database error on first query (owner check)
206 |       mockQuery.mockRejectedValueOnce(new Error('Database connection failed'));
                                                ^
error: Database connection failed
      at <anonymous> (C:\Users\Jhonatan\Documents\git\lazykanban\src\__tests__\api\projects\tags.test.ts:206:43)

(pass) POST /api/projects/[id]/tags - Security Tests > Database Errors > should handle database errors gracefully
(pass) POST /api/projects/[id]/tags - Security Tests > Database Errors > should handle duplicate tag names

src\__tests__\api\tags\tags-crud.test.ts:
(pass) Tags CRUD - Security Tests > PATCH /api/tags/[id] - Edit Tag > should allow project owner to edit tag
Update tag error: 90 |     }
91 |     get cookies() {
92 |         return this[INTERNALS].cookies;
93 |     }
94 |     static json(body, init) {
95 |         const response = Response.json(body, init);
                                       ^
TypeError: Value is not JSON serializable
      at json (C:\Users\Jhonatan\Documents\git\lazykanban\node_modules\next\dist\server\web\spec-extension\response.js:95:35)
      at handlePATCH (C:\Users\Jhonatan\Documents\git\lazykanban\src\app\api\tags\[id]\route.ts:95:25)

92 | 
93 |       const req = createMockRequest(userId, updates);
94 |       const response = await PATCH(req, mockParams(tagId));
95 |       const data = await response.json();
96 | 
97 |       expect(response.status).toBe(200);
                                   ^
error: expect(received).toBe(expected)

Expected: 200
Received: 500

      at <anonymous> (C:\Users\Jhonatan\Documents\git\lazykanban\src\__tests__\api\tags\tags-crud.test.ts:97:31)
(fail) Tags CRUD - Security Tests > PATCH /api/tags/[id] - Edit Tag > should allow member with can_manage_tags permission
Update tag error: 85 |     await db.query(
86 |       `UPDATE tags SET ${updates.join(", ")} WHERE id = ?`,
87 |       values
88 |     );
89 | 
90 |     const [tags] = await db.query<RowDataPacket[]>(
                                 ^
TypeError: undefined is not an object (evaluating 'db.query("SELECT * FROM tags WHERE id = ?", [id])')
      at handlePATCH (C:\Users\Jhonatan\Documents\git\lazykanban\src\app\api\tags\[id]\route.ts:90:29)

111 | 
112 |       const req = createMockRequest(userId, updates);
113 |       const response = await PATCH(req, mockParams(tagId));
114 |       const data = await response.json();
115 | 
116 |       expect(response.status).toBe(403);
                                    ^
error: expect(received).toBe(expected)

Expected: 403
Received: 500

      at <anonymous> (C:\Users\Jhonatan\Documents\git\lazykanban\src\__tests__\api\tags\tags-crud.test.ts:116:31)
(fail) Tags CRUD - Security Tests > PATCH /api/tags/[id] - Edit Tag > should deny member without permission
(pass) Tags CRUD - Security Tests > PATCH /api/tags/[id] - Edit Tag > should return 404 for non-existent tag
(pass) Tags CRUD - Security Tests > PATCH /api/tags/[id] - Edit Tag > should reject empty updates
(pass) Tags CRUD - Security Tests > DELETE /api/tags/[id] - Delete Tag > should allow project owner to delete tag
(pass) Tags CRUD - Security Tests > DELETE /api/tags/[id] - Delete Tag > should prevent deletion of default system tags
199 | 
200 |       const req = createMockRequest(userId);
201 |       const response = await DELETE(req, mockParams(tagId));
202 |       const data = await response.json();
203 | 
204 |       expect(response.status).toBe(403);
                                    ^
error: expect(received).toBe(expected)

Expected: 403
Received: 200

      at <anonymous> (C:\Users\Jhonatan\Documents\git\lazykanban\src\__tests__\api\tags\tags-crud.test.ts:204:31)
(fail) Tags CRUD - Security Tests > DELETE /api/tags/[id] - Delete Tag > should deny deletion without permission

4 tests failed:
(fail) POST /api/projects/[id]/tags - Security Tests > Owner-First Permission Pattern > should allow member with can_manage_tags permission
(fail) Tags CRUD - Security Tests > PATCH /api/tags/[id] - Edit Tag > should allow member with can_manage_tags permission
(fail) Tags CRUD - Security Tests > PATCH /api/tags/[id] - Edit Tag > should deny member without permission
(fail) Tags CRUD - Security Tests > DELETE /api/tags/[id] - Delete Tag > should deny deletion without permission

 21 pass
 4 fail
 58 expect() calls
Ran 25 tests across 3 files. [238.00ms]
